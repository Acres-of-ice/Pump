# Pump Controller - Cellular IoT Device

ESP32-S3 based remote pump controller with cellular connectivity and MQTT cloud integration. This project was generated using [Mongoose Wizard](https://mongoose.ws/wizard/) and extended with SIM7600 modem support for remote deployment.

## Hardware Features

### Main Controller
- **MCU:** ESP32-S3 dual-core @ 240MHz
- **PSRAM:** 2MB or 8MB external PSRAM (QUAD/OCT modes)
- **Flash:** 16MB SPI flash
- **Power:** Optimized for low power consumption with sleep modes

### Connectivity
- **Cellular Modem:** SIM7600 4G LTE module
  - Global band support (LTE-FDD, LTE-TDD, WCDMA, GSM)
  - UART interface @ 115200 baud
  - PPP protocol for internet connectivity
  - Supports SMS and voice (hardware capable, SMS implemented)
- **WiFi:** ESP32-S3 built-in (currently disabled, SIM preferred)
- **Bluetooth:** ESP32-S3 built-in (not utilized)

### Pump Control Interface
- **Relay Control:** Dual GPIO outputs for safe pump operation
  - GPIO12: PUMP_ON signal
  - GPIO13: PUMP_OFF signal (safety interlock)
  - Mutually exclusive states prevent accidental activation
- **Status LED:** GPIO8 for visual feedback

### Camera Support (Hardware Ready)
- **Camera Sensor:** OV5640 5MP camera (configured but not actively used)
- **Interface:** SCCB (I2C-compatible) + parallel data
- **Buffers:** PSRAM-allocated for image capture
- **Use Case:** Future expansion for visual monitoring

### Modem Hardware Interface
- **UART2 Pins:**
  - TX: GPIO18 → SIM7600 RX
  - RX: GPIO17 ← SIM7600 TX
  - Baud: 115200 (auto-negotiated)
- **Control Pins:**
  - DTR: GPIO45 (power management, LOW=awake)
  - RI: GPIO40 (ring indicator input)
  - PWRKEY: Not used (modem auto-starts)

### Memory Architecture
- **NVS:** 16KB for WiFi credentials, settings
- **OTA Partitions:** Dual 1.7MB app slots for safe firmware updates
- **SPIFFS:** 512KB for web dashboard assets
- **PHY Init:** 4KB for RF calibration data

## PCB Variants

The project supports two PSRAM configurations:

### 2MB PSRAM Board (`pcb/2mb.cfg`)
- PSRAM Mode: QUAD @ 40MHz
- Recommended for: Standard pump control applications
- Watchdog: Enabled
- Cache: 32KB instruction + 64KB data

### 8MB PSRAM Board (`pcb/8mb.cfg`)
- PSRAM Mode: OCT @ 80MHz
- Recommended for: Camera-enabled or data-intensive applications
- Watchdog: Disabled (high interrupt latency in OCT mode)
- Cache: Optimized for OCT access patterns

## Build and Flash

### Quick Start
```sh
# Set target (first time only)
$ idf.py set-target esp32s3

# Build, flash, and monitor for 2MB PSRAM boards
$ idf.py @pcb/2mb.cfg build flash monitor

# Build, flash, and monitor for 8MB PSRAM boards
$ idf.py @pcb/8mb.cfg build flash monitor
```

### Docker Build
```sh
$ docker run --rm -v `pwd`:`pwd` -w `pwd` espressif/idf idf.py set-target esp32s3
$ docker run --rm -v `pwd`:`pwd` -w `pwd` espressif/idf idf.py @pcb/2mb.cfg build
```

### Serial Port
Replace `/dev/ttyUSB0` with your actual port:
```sh
$ idf.py -p /dev/ttyUSB0 @pcb/2mb.cfg flash monitor
```

## Features

- **Remote Control:** MQTT-based pump control from anywhere with cellular coverage
- **OTA Updates:** Over-the-air firmware updates via MQTT (no physical access needed)
- **Status Monitoring:** Real-time device status and pump state reporting
- **Web Dashboard:** Standalone HTML dashboard for control and monitoring
- **Reliable Connectivity:** Automatic reconnection and network recovery
- **Low Power:** Optimized for battery or solar-powered deployments
- **Secure:** Optional TLS/SSL support for MQTT connections

## System Requirements

- **ESP-IDF:** v5.0 or later (tested with v5.4)
- **Python:** 3.8+ (for ESP-IDF tools)
- **SIM Card:** Active data plan with any carrier (APN: "internet" by default)
- **MQTT Broker:** Public (broker.hivemq.com) or private broker

## Project Structure

- `main/` - Application code (main.c, SIM modem driver, WiFi)
- `mongoose/` - Embedded web server library and MQTT client
- `components/` - ESP-IDF components (esp_modem)
- `pcb/` - PCB-specific build configurations
- `index.html` - Web dashboard for pump control
- `partitions.csv` - Flash memory partition table

## Documentation

See [CLAUDE.md](CLAUDE.md) for detailed architecture, hardware mappings, MQTT protocol documentation, and development notes.

## License

Generated by Mongoose Wizard, https://mongoose.ws/wizard/
SPDX-License-Identifier: GPL-2.0-only or commercial
