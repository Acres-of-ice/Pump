
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pump Controller ‚Ä¢ Scheduler</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fafafa;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-mute: #64748b;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --radius: 10px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }
        .app-header {
            max-width: 1280px;
            margin: 0 auto;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            background: white;
        }
        .app-title {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }
        .dashboard {
            max-width: 1280px;
            margin: 32px auto;
            padding: 0 24px;
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 32px;
        }
        .sidebar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            height: fit-content;
            box-shadow: var(--shadow-sm);
        }
        .sidebar-header {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-mute);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .device-list { list-style: none; }
        .device-item {
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
            font-weight: 500;
            color: var(--text);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .device-item:hover { background: #f1f5f9; }
        .device-item.active {
            background: var(--accent);
            color: white;
        }
        .device-name {
            flex: 1;
        }
        .device-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
            flex-shrink: 0;
        }
        .indicator-online {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
            animation: pulse-green 2s infinite;
        }
        .indicator-offline {
            background: var(--danger);
        }
        .indicator-unknown {
            background: var(--warning);
        }
        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .main-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 32px;
            box-shadow: var(--shadow-md);
        }
        .connection {
            font-size: 0.875rem;
            color: var(--text-mute);
            margin-bottom: 32px;
            padding: 12px;
            border-radius: 8px;
            background: #f8fafc;
        }
        .connection.connected { background: #d1fae5; color: var(--success); }
        .connection.disconnected { background: #fee; color: var(--danger); }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border);
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-mute);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab:hover { color: var(--accent); }
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .control-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 32px;
            margin: 40px 0;
        }
        .buttons {
            display: flex;
            gap: 24px;
        }
        .control-btn {
            width: 120px;
            height: 120px;
            border: none;
            border-radius: var(--radius);
            font-size: 1.125rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .btn-on { background: var(--success); }
        .btn-off { background: var(--danger); }
        .status-box { text-align: center; }
        .pump-state {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .state-on { color: var(--success); }
        .state-off { color: var(--danger); }
        .status-label {
            font-size: 0.95rem;
            color: var(--text-mute);
        }
        
        .scheduler-section {
            background: #f8fafc;
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
        }
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
        }
        input[type="datetime-local"],
        input[type="number"],
        select {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        .btn-primary:hover { background: #2563eb; }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-danger:hover { background: #dc2626; }
        
        .schedule-list {
            margin-top: 24px;
        }
        .schedule-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .schedule-info {
            flex: 1;
        }
        .schedule-time {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }
        .schedule-details {
            font-size: 0.875rem;
            color: var(--text-mute);
        }
        .schedule-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-active {
            background: #d1fae5;
            color: var(--success);
        }
        .status-inactive {
            background: #fee;
            color: var(--danger);
        }
        .schedule-actions {
            display: flex;
            gap: 8px;
            margin-left: 16px;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        
        .ota-section {
            background: #f8fafc;
            border-radius: var(--radius);
            padding: 24px;
        }
        .file-input {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            cursor: pointer;
            margin-bottom: 16px;
            display: block;
            width: 100%;
        }
        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }
        .progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.4s ease;
        }
        .ota-status {
            font-size: 0.875rem;
            min-height: 1.2em;
            margin-top: 12px;
        }
        .ota-status.waiting { color: var(--warning); }
        .ota-status.success { color: var(--success); }
        .ota-status.error { color: var(--danger); }
        
        @media (max-width: 960px) {
            .dashboard { grid-template-columns: 1fr; }
            .sidebar { order: -1; }
            .buttons { flex-direction: column; align-items: center; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="app-title">üöø Pump Controller</div>
    </header>

    <div class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">Devices</div>
            <ul class="device-list" id="deviceList"></ul>
        </aside>

        <main class="main-panel">
            <div class="connection" id="connectionStatus">Connecting‚Ä¶</div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('control')">Manual Control</button>
                <button class="tab" onclick="switchTab('scheduler')">Scheduler</button>
                <button class="tab" onclick="switchTab('ota')">Firmware Update</button>
            </div>

            <div id="tab-control" class="tab-content active">
                <section class="control-section">
                    <div class="buttons">
                        <button class="control-btn btn-on" id="onBtn">ON</button>
                        <button class="control-btn btn-off" id="offBtn">OFF</button>
                    </div>
                    <div class="status-box">
                        <div class="pump-state" id="pumpStatus">Pump OFF</div>
                        <div class="status-label">Current Pump Status</div>
                    </div>
                </section>
            </div>

            <div id="tab-scheduler" class="tab-content">
                <div class="scheduler-section">
                    <div class="section-title">Create New Schedule</div>
                    
                    <div style="background: #e0f2fe; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 0.875rem;">
                        ‚ÑπÔ∏è <strong>Timezone:</strong> <span id="userTimezone"></span> - All times are in your local timezone
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Start Date & Time</label>
                            <input type="datetime-local" id="scheduleStart" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" id="scheduleDuration" min="1" max="1440" value="60" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Repeat Frequency</label>
                            <select id="scheduleFrequency">
                                <option value="once">Once (One-time)</option>
                                <option value="daily" selected>Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="hourly">Every Hour</option>
                                <option value="custom">Custom (hours)</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="customIntervalGroup" style="display: none;">
                            <label class="form-label">Custom Interval (hours)</label>
                            <input type="number" id="customInterval" min="1" max="168" value="12">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="createSchedule()">Create Schedule</button>
                </div>

                <div class="schedule-list">
                    <div class="section-title">Active Schedules</div>
                    <div id="schedulesList"></div>
                </div>
            </div>

            <div id="tab-ota" class="tab-content">
                <section class="ota-section">
                    <div class="section-title">Firmware Update (OTA)</div>
                    <input type="file" id="firmwareFile" accept=".bin" class="file-input">
                    <button id="uploadBtn" class="btn btn-primary">Start OTA Upload</button>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div id="otaStatus" class="ota-status"></div>
                </section>
            </div>
        </main>
    </div>

    <script>

        const brokerUrl = 'ws://44.194.157.172:9001';
        const prefix = 'pump';
        const TIMEOUT_MS = 30000; // 30 seconds
        const GRACE_PERIOD = 5000; // 5 second grace period on first load
        
   const options = {
       username: 'aoi',      
       password: '4201',     
       clean: true,
       connectTimeout: 5000,
       clientId: 'pump-controller-' + Math.random().toString(16).substr(2, 8),
   };

        let client = null;
        let selectedDevice = null;
        let devices = {};
        let schedules = [];
        let timeoutChecker = null;
        let dashboardStartTime = Date.now();
        let dashboardConnectTime = 0;
        const chunkSize = 4096;
        
        // ‚úÖ PERSISTENT STORAGE - Save devices permanently
        async function saveDeviceList() {
            try {
                const deviceNames = Object.keys(devices);
                await window.storage.set('known_devices', JSON.stringify(deviceNames), false);
                console.log('[STORAGE] Saved devices:', deviceNames);
            } catch (e) {
                console.error('[STORAGE] Save failed:', e);
            }
        }
        
        async function loadDeviceList() {
            try {
                const result = await window.storage.get('known_devices', false);
                if (result && result.value) {
                    const deviceNames = JSON.parse(result.value);
                    console.log('[STORAGE] Loaded devices:', deviceNames);
                    
                    deviceNames.forEach(deviceName => {
                        if (!devices[deviceName]) {
                            devices[deviceName] = {
                                pump_status: false,
                                lastHeartbeat: 0,
                                online: false
                            };
                        }
                    });
                    updateDeviceList();
                }
            } catch (e) {
                console.log('[STORAGE] No saved devices or load failed:', e);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        document.getElementById('scheduleFrequency')?.addEventListener('change', function() {
            const customGroup = document.getElementById('customIntervalGroup');
            customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
        });

        // ‚úÖ FIX 1: Check for device timeouts - respects grace period on startup
        function startTimeoutChecker() {
            if (timeoutChecker) clearInterval(timeoutChecker);
            
            timeoutChecker = setInterval(() => {
                const now = Date.now();
                let changed = false;
                
                // ‚úÖ Skip timeout checking during grace period (first 5 seconds)
                if (now - dashboardStartTime < GRACE_PERIOD) {
                    return;
                }
                
                Object.keys(devices).forEach(deviceName => {
                    const device = devices[deviceName];
                    const timeSinceLastSeen = now - device.lastHeartbeat;
                    
                    // Only mark offline if we've received at least one message
                    if (device.online && device.lastHeartbeat > 0 && timeSinceLastSeen > TIMEOUT_MS) {
                        console.log(`[TIMEOUT] ${deviceName} offline (${timeSinceLastSeen}ms since last heartbeat)`);
                        device.online = false;
                        changed = true;
                    }
                });
                
                if (changed) {
                    updateDeviceList();
                    if (selectedDevice && devices[selectedDevice]) {
                        updatePumpStatus();
                    }
                }
            }, 10000);
        }

        function updateDeviceList() {
            const list = document.getElementById('deviceList');
            list.innerHTML = '';
            
            const deviceIds = Object.keys(devices);
            
            if (!selectedDevice && deviceIds.length > 0) {
                selectedDevice = deviceIds[0];
                console.log('[AUTO] Selected device:', selectedDevice);
            }
            
            deviceIds.forEach(id => {
                const device = devices[id];
                const li = document.createElement('li');
                li.className = 'device-item' + (id === selectedDevice ? ' active' : '');
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'device-name';
                nameSpan.textContent = id;
                
                const indicator = document.createElement('span');
                // ‚úÖ Show unknown state if no heartbeat yet
                let statusClass = 'indicator-unknown';
                let statusTitle = 'Unknown';
                
                if (device.lastHeartbeat > 0) {
                    statusClass = device.online ? 'indicator-online' : 'indicator-offline';
                    statusTitle = device.online ? 'Online' : 'Offline';
                }
                
                indicator.className = 'device-indicator ' + statusClass;
                indicator.title = statusTitle;
                
                li.appendChild(nameSpan);
                li.appendChild(indicator);
                li.onclick = () => selectDevice(id);
                list.appendChild(li);
            });
            
            if (deviceIds.length === 0) {
                list.innerHTML = '<p style="color: var(--text-mute); text-align: center; padding: 10px; font-size: 0.875rem;">No devices found</p>';
            }
        }

        function selectDevice(id) {
            selectedDevice = id;
            updateDeviceList();
            updatePumpStatus();
            loadSchedules();
        }

        function updatePumpStatus() {
            const el = document.getElementById('pumpStatus');
            if (devices[selectedDevice]) {
                const device = devices[selectedDevice];
                if (!device.online && device.lastHeartbeat > 0) {
                    el.textContent = 'Device Offline';
                    el.className = 'pump-state state-off';
                } else if (device.lastHeartbeat === 0) {
                    el.textContent = 'Waiting...';
                    el.className = 'pump-state state-off';
                } else {
                    const isOn = device.pump_status;
                    el.textContent = `Pump ${isOn ? 'ON' : 'OFF'}`;
                    el.className = 'pump-state ' + (isOn ? 'state-on' : 'state-off');
                }
            } else {
                el.textContent = 'Pump OFF';
                el.className = 'pump-state state-off';
            }
        }

        function createSchedule() {
            if (!client?.connected || !selectedDevice) {
                alert('Not connected or no device selected');
                return;
            }

            const startTime = document.getElementById('scheduleStart').value;
            const duration = parseInt(document.getElementById('scheduleDuration').value);
            const frequency = document.getElementById('scheduleFrequency').value;
            const customInterval = parseInt(document.getElementById('customInterval').value);

            if (!startTime || !duration) {
                alert('Please fill in all required fields');
                return;
            }

            const localDate = new Date(startTime);
            const startTimestamp = Math.floor(localDate.getTime() / 1000);
            
            let intervalSeconds = 0;
            switch(frequency) {
                case 'once': intervalSeconds = 0; break;
                case 'hourly': intervalSeconds = 3600; break;
                case 'daily': intervalSeconds = 86400; break;
                case 'weekly': intervalSeconds = 604800; break;
                case 'custom': intervalSeconds = customInterval * 3600; break;
            }

            const schedule = {
                id: Date.now(),
                start: startTimestamp,
                duration: duration * 60,
                interval: intervalSeconds,
                enabled: true
            };

            const command = JSON.stringify({
                method: "schedule.add",
                params: schedule
            });

            console.log('[SCHEDULE] Creating:', schedule);
            client.publish(`${prefix}/${selectedDevice}/rx`, command, { qos: 1 });
            
            schedules.push(schedule);
            renderSchedules();
            
            document.getElementById('scheduleStart').value = '';
            document.getElementById('scheduleDuration').value = '60';
        }

        function deleteSchedule(scheduleId) {
            if (!confirm('Delete this schedule?')) return;
            
            const command = JSON.stringify({
                method: "schedule.delete",
                params: { id: scheduleId }
            });
            
            client.publish(`${prefix}/${selectedDevice}/rx`, command, { qos: 1 });
            schedules = schedules.filter(s => s.id !== scheduleId);
            renderSchedules();
        }

        function toggleSchedule(scheduleId) {
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) return;
            
            schedule.enabled = !schedule.enabled;
            
            const command = JSON.stringify({
                method: "schedule.toggle",
                params: { id: scheduleId, enabled: schedule.enabled }
            });
            
            client.publish(`${prefix}/${selectedDevice}/rx`, command, { qos: 1 });
            renderSchedules();
        }

        function loadSchedules() {
            if (!client?.connected || !selectedDevice) return;
            const command = JSON.stringify({ method: "schedule.list" });
            client.publish(`${prefix}/${selectedDevice}/rx`, command, { qos: 1 });
        }

        function renderSchedules() {
            const container = document.getElementById('schedulesList');
            if (schedules.length === 0) {
                container.innerHTML = '<p style="color: var(--text-mute); text-align: center; padding: 20px;">No schedules created yet</p>';
                return;
            }

            container.innerHTML = schedules.map(s => {
                const startDate = new Date(s.start * 1000);
                const durationHours = Math.floor(s.duration / 3600);
                const durationMins = Math.floor((s.duration % 3600) / 60);
                const durationStr = durationHours > 0 ? `${durationHours}h ${durationMins}m` : `${durationMins}m`;
                
                let frequencyStr = 'Once';
                if (s.interval === 3600) frequencyStr = 'Every hour';
                else if (s.interval === 86400) frequencyStr = 'Daily';
                else if (s.interval === 604800) frequencyStr = 'Weekly';
                else if (s.interval > 0) frequencyStr = `Every ${s.interval / 3600}h`;
                
                const displayTime = startDate.toLocaleString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                
                return `
                    <div class="schedule-item">
                        <div class="schedule-info">
                            <div class="schedule-time">üïí ${displayTime}</div>
                            <div class="schedule-details">Duration: ${durationStr} ‚Ä¢ ${frequencyStr}</div>
                        </div>
                        <div class="schedule-status ${s.enabled ? 'status-active' : 'status-inactive'}">
                            ${s.enabled ? 'Active' : 'Disabled'}
                        </div>
                        <div class="schedule-actions">
                            <button class="btn btn-small ${s.enabled ? 'btn-danger' : 'btn-success'}" 
                                    onclick="toggleSchedule(${s.id})">
                                ${s.enabled ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteSchedule(${s.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('onBtn').addEventListener('click', () => {
            if (client?.connected && selectedDevice) {
                client.publish(`${prefix}/${selectedDevice}/rx`, 'PUMP ON', { qos: 1 });
            }
        });

        document.getElementById('offBtn').addEventListener('click', () => {
            if (client?.connected && selectedDevice) {
                client.publish(`${prefix}/${selectedDevice}/rx`, 'PUMP OFF', { qos: 1 });
            }
        });

        // ‚úÖ FIX 2: OTA Upload functionality
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('firmwareFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a firmware file (.bin)');
                return;
            }
            
            if (!selectedDevice) {
                alert('No device selected');
                return;
            }
            
            const progressFill = document.getElementById('progressFill');
            const otaStatus = document.getElementById('otaStatus');
            const uploadBtn = document.getElementById('uploadBtn');
            
            uploadBtn.disabled = true;
            otaStatus.className = 'ota-status waiting';
            otaStatus.textContent = 'Starting upload...';
            progressFill.style.width = '0%';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                const total = uint8Array.length;
                let offset = 0;
                
                console.log(`[OTA] Starting upload: ${total} bytes`);
                
                while (offset < total) {
                    const chunk = uint8Array.slice(offset, offset + chunkSize);
                    const base64Chunk = btoa(String.fromCharCode.apply(null, chunk));
                    
                    const otaMessage = JSON.stringify({
                        method: "ota.upload",
                        params: {
                            offset: offset,
                            total: total,
                            chunk: base64Chunk
                        }
                    });
                    
                    client.publish(`${prefix}/${selectedDevice}/rx`, otaMessage, { qos: 1 });
                    
                    offset += chunk.length;
                    const progress = (offset / total) * 100;
                    progressFill.style.width = progress + '%';
                    otaStatus.textContent = `Uploading: ${progress.toFixed(1)}% (${offset}/${total} bytes)`;
                    
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                otaStatus.className = 'ota-status success';
                otaStatus.textContent = '‚úÖ Upload complete! Device is rebooting...';
                console.log('[OTA] Upload complete');
                
                setTimeout(() => {
                    uploadBtn.disabled = false;
                    fileInput.value = '';
                }, 5000);
                
            } catch (error) {
                console.error('[OTA] Error:', error);
                otaStatus.className = 'ota-status error';
                otaStatus.textContent = '‚ùå Upload failed: ' + error.message;
                uploadBtn.disabled = false;
            }
        });

        function connect() {
            client = mqtt.connect(brokerUrl, options);

            client.on('connect', () => {
                document.getElementById('connectionStatus').textContent = 'Connected';
                document.getElementById('connectionStatus').className = 'connection connected';

                client.subscribe(`${prefix}/+/status`);
                client.subscribe(`${prefix}/+/tx`);
                // ‚úÖ Track when dashboard connected
               dashboardConnectTime = Date.now();
               devices = {};
               updateDeviceList();
               startTimeoutChecker();
               console.log('[MQTT] Connected, waiting for live heartbeats...');
            });

            client.on('error', (err) => {
                document.getElementById('connectionStatus').textContent = `Failed: ${err.message}`;
                document.getElementById('connectionStatus').className = 'connection disconnected';
            });

            client.on('close', () => {
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                document.getElementById('connectionStatus').className = 'connection disconnected';
            });

client.on('message', (topic, message) => {
    const parts = topic.split('/');
    if (parts.length === 3 && parts[2] === 'status') {
        const id = parts[1];
        try {
            const data = JSON.parse(message.toString());
            
            if (data.method === 'status.notify') {
                const now = Date.now();
                
                // ‚úÖ Ignore retained messages from before dashboard connected
                // Only accept messages that arrive after 5 second grace period
                if (now - dashboardConnectTime < 5000) {
                    console.log(`[IGNORE] Skipping potential retained message from ${id} (grace period)`);
                    return;
                }
                
                // Initialize device if not exists
                if (!devices[id]) {
                    devices[id] = {
                        pump_status: false,
                        lastHeartbeat: 0,
                        online: false
                    };
                }
                
                // Update device state
                devices[id].pump_status = !!data.params?.pump_status;
                devices[id].lastHeartbeat = now;
                devices[id].online = true;
                
                console.log(`[HEARTBEAT] ${id}: pump=${devices[id].pump_status}, online=true`);
                
                updateDeviceList();
                if (id === selectedDevice) updatePumpStatus();
            }
        } catch (e) {
            console.error('[PARSE ERROR]', e);
        }
    }
});
        }

        // document.getElementById('onBtn').addEventListener('click', () => {
        //     if (client?.connected && selectedDevice) {
        //         client.publish(`${prefix}/${selectedDevice}/rx`, 'PUMP ON', { qos: 1 });
        //     } else {
        //         alert('Not connected or no device selected');
        //     }
        // });

        // document.getElementById('offBtn').addEventListener('click', () => {
        //     if (client?.connected && selectedDevice) {
        //         client.publish(`${prefix}/${selectedDevice}/rx`, 'PUMP OFF', { qos: 1 });
        //     } else {
        //         alert('Not connected or no device selected');
        //     }
        // });

        document.getElementById('firmwareFile').addEventListener('change', (e) => {
            document.getElementById('uploadBtn').disabled = !e.target.files[0];
        });

        document.getElementById('uploadBtn').addEventListener('click', () => {
            const file = document.getElementById('firmwareFile').files[0];
            if (file) uploadFirmware(file);
        });

        connect();
    </script>
</body>
</html>
