<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pump Controller • Acres of Ice</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* (keeping your existing styles – only adding for OTA feedback) */
        .ota-status.debug { color: #7c3aed; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <!-- Your existing HTML structure remains the same -->
    <!-- ... header, dashboard, sidebar, main-panel, control-section ... -->

    <section class="ota-section">
        <div class="ota-header">Firmware Update (OTA)</div>
        <div class="ota-form">
            <input type="file" id="firmwareFile" accept=".bin" class="file-input">
            <button id="uploadBtn" class="upload-btn" disabled>Start OTA Upload</button>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="otaStatus" class="ota-status"></div>
        </div>
    </section>

    <!-- Rest of body -->

    <script>
        // ... (keep your existing variables, updateDeviceList, selectDevice, updatePumpStatus, connect, pump buttons)

        async function uploadFirmware(file) {
            if (otaInProgress) return;
            if (!client?.connected || !selectedDevice) {
                setOtaStatus('Not connected or no device selected', 'error');
                return;
            }

            otaInProgress = true;
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            setOtaStatus('Starting OTA upload...', 'waiting');
            updateProgress(0);

            const rxTopic = `${prefix}/${selectedDevice}/rx`;
            const txTopic = `${prefix}/${selectedDevice}/tx`;
            const totalSize = file.size;
            let offset = 0;

            try {
                while (offset < totalSize) {
                    const chunk = file.slice(offset, offset + chunkSize);
                    const base64 = await chunkToBase64(chunk);

                    const payload = JSON.stringify({
                        method: "ota.upload",
                        params: { offset, total: totalSize, chunk: base64 }
                    });

                    setOtaStatus(`Sending chunk ${offset} – ${offset + chunk.size}/${totalSize} bytes...`, 'waiting');

                    await sendChunkAndWaitForAck(rxTopic, txTopic, payload, offset);

                    offset += chunk.size;
                    updateProgress((offset / totalSize) * 100);
                }

                setOtaStatus('Upload complete. Device should reboot and apply update.', 'success');
            } catch (err) {
                console.error('OTA failed:', err);
                setOtaStatus(`Upload failed: ${err.message}`, 'error');
            } finally {
                otaInProgress = false;
                uploadBtn.disabled = false;
                updateProgress(0);
            }
        }

        function chunkToBase64(chunk) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(chunk);
            });
        }

        function sendChunkAndWaitForAck(rxTopic, txTopic, payload, currentOffset) {
            return new Promise((resolve, reject) => {
                let responded = false;
                const timeoutMs = 40000; // 40 seconds – SIM can be very slow

                const timeoutId = setTimeout(() => {
                    if (!responded) {
                        responded = true;
                        client.off('message', messageHandler);
                        reject(new Error(`No valid response after ${timeoutMs/1000}s (offset ${currentOffset})`));
                    }
                }, timeoutMs);

                const messageHandler = (topic, message) => {
                    if (topic !== txTopic) return;

                    const rawText = message.toString().trim();
                    console.log(`[TX RAW] ${rawText}`);

                    responded = true;
                    clearTimeout(timeoutId);
                    client.off('message', messageHandler);

                    setOtaStatus(`Received response: ${rawText.slice(0, 100)}...`, 'debug');

                    try {
                        const json = JSON.parse(rawText);
                        if (json.result && json.result.status === 'ok') {
                            setOtaStatus(`Chunk accepted (offset ${currentOffset})`, 'success');
                            resolve();
                        } else if (json.error) {
                            reject(new Error(json.error.message || 'Device error'));
                        } else {
                            reject(new Error('Response missing "result" or "ok"'));
                        }
                    } catch (parseErr) {
                        console.warn('Parse failed – raw:', rawText);
                        setOtaStatus(`Invalid response format: ${rawText.slice(0, 80)}...`, 'error');
                        // Do NOT reject here – allow timeout to handle
                    }
                };

                client.on('message', messageHandler);

                client.publish(rxTopic, payload, { qos: 1 }, (err) => {
                    if (err) {
                        clearTimeout(timeoutId);
                        client.off('message', messageHandler);
                        reject(new Error('Publish failed: ' + err.message));
                    }
                });
            });
        }

        function setOtaStatus(msg, type = '') {
            document.getElementById('otaStatus').textContent = msg;
            document.getElementById('otaStatus').className = 'ota-status ' + type;
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = `${percent}%`;
        }

        // ... rest of your script (file change listener, upload button click, connect())
    </script>
</body>
</html>
