# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an ESP32-based pump controller project generated by Mongoose Wizard (https://mongoose.ws/wizard/). The device controls a water pump via MQTT commands and supports OTA firmware updates. It uses cellular connectivity (SIM7600 modem) for internet access.

**Target Device:** ESP32-S3 with PSRAM (2MB or 8MB configurations)
**Network:** SIM7600 cellular modem (PPP over UART2)
**Protocol:** MQTT over cellular network
**Framework:** ESP-IDF (version 5.4+)

## Build Commands

### PCB-specific Builds
The build system uses configuration files from `pcb/*.cfg`:
- `pcb/2mb.cfg` - 2MB PSRAM, QUAD mode @ 40MHz
- `pcb/8mb.cfg` - 8MB PSRAM, OCT mode @ 80MHz

```sh
# Set target (first time only)
idf.py set-target esp32s3

# Build, flash, and monitor for 2MB PSRAM boards
idf.py @pcb/2mb.cfg build flash monitor

# Build, flash, and monitor for 8MB PSRAM boards
idf.py @pcb/8mb.cfg build flash monitor

# Just build (without flashing)
idf.py @pcb/2mb.cfg build

# Just monitor serial output
idf.py -p /dev/ttyUSB0 monitor
```

### Docker Build (alternative)
```sh
docker run --rm -v `pwd`:`pwd` -w `pwd` espressif/idf idf.py set-target esp32s3
docker run --rm -v `pwd`:`pwd` -w `pwd` espressif/idf idf.py @pcb/2mb.cfg build
```

## Architecture

### Core Components

**Main Application (`main/main.c`)**
- Entry point: `app_main()`
- Initializes SIM modem, Mongoose web server, GPIO
- Runs main event loop with MQTT polling
- Handles OTA updates and pump control via MQTT

**SIM Modem Layer (`main/sim.c`, `main/sim.h`)**
- Manages SIM7600 modem initialization and PPP connection
- UART2 communication (GPIO17=RX, GPIO18=TX)
- Auto-detects APN and handles baud rate negotiation
- Provides internet connectivity status
- Key functions: `sim_init()`, `sim_is_connected()`, `isPPPConnected()`

**Mongoose Integration (`mongoose/`)**
- Single-file embedded web server library
- Custom glue code in `mongoose_glue.c` connects ESP-IDF to Mongoose
- Handles MQTT protocol, TLS, and HTTP
- Configuration via `mongoose_wizard.json`

**Web Dashboard (`index.html`)**
- Standalone HTML/CSS/JS dashboard for pump control
- Connects to MQTT broker (broker.hivemq.com:1883)
- Can be served via SPIFFS or used independently

### Hardware Interface

**Pump Control:**
- GPIO12 (PUMP_ON_GPIO): Set HIGH to turn pump ON
- GPIO13 (PUMP_OFF_GPIO): Set HIGH for safety/off state
- Mutually exclusive states: ON=(12:HIGH, 13:LOW), OFF=(12:LOW, 13:HIGH)

**Status LED:**
- GPIO8: Status indicator

**SIM Modem (SIM7600):**
- UART2: GPIO17 (RX), GPIO18 (TX) @ 115200 baud
- DTR: GPIO45 (power management)
- RI: GPIO40 (ring indicator)
- PWRKEY: Not used (SIM_GPIO=-1)

### MQTT Communication

**Topics:**
- RX: `mg_mqtt_dashboard/{DEVICE_ID}/rx` - Commands from cloud
- TX: `mg_mqtt_dashboard/{DEVICE_ID}/tx` - Responses to cloud
- Status: `mg_mqtt_dashboard/{DEVICE_ID}/status` - Device status updates

**Device ID:** Fixed to "Shey" (see `DEVICE_ID` in main.c)

**Commands:**
- `"PUMP ON"` - Turn pump on
- `"PUMP OFF"` - Turn pump off
- `{"method":"ota.upload","params":{...}}` - OTA firmware update

**Status Messages:**
```json
{
  "method": "status.notify",
  "params": {
    "status": "online",
    "pump_status": true/false,
    "firmware_version": "1.0.2"
  }
}
```

### OTA Update Process

1. Device subscribes to `{DEVICE_ID}/rx` topic
2. Cloud sends chunked firmware via `ota.upload` RPC calls
3. Chunks are base64-encoded in JSON payload
4. Device writes to next OTA partition (app0 â†” app1)
5. On completion, device reboots into new firmware
6. See `rpc_ota_upload()` in main.c

### Memory Configuration

**Partition Table (`partitions.csv`):**
- NVS: 16KB (non-volatile storage)
- OTA data: 8KB (boot partition selector)
- PHY init: 4KB (RF calibration)
- app0: 1.7MB (primary firmware slot)
- app1: 1.7MB (OTA update slot)
- SPIFFS: 512KB (filesystem for web assets)

**PSRAM Configuration:**
- 2MB boards: QUAD mode @ 40MHz (enabled in sdkconfig.defaults.2mb)
- 8MB boards: OCT mode @ 80MHz (requires disabling watchdogs)
- Camera buffers use PSRAM allocation
- Toggle between configs by uncommenting respective sections in sdkconfig.defaults.2mb

### Network Stack

**Initialization Flow:**
1. `sim_init()` - Initialize SIM7600 modem via UART
2. PPP connection established with cellular network
3. SNTP time synchronization
4. `mongoose_init()` - Start Mongoose event manager
5. MQTT connection to broker.hivemq.com
6. Subscribe to command topics

**Dependencies:**
- ESP-IDF netif/lwIP for TCP/IP stack
- PPP for cellular data connection
- esp_modem component for AT command interface

## Development Notes

### Logging
- Default log level: INFO
- Tag-based logging: "PUMP", "SIM", etc.
- Runtime log level can be changed (CONFIG_LOG_MAXIMUM_EQUALS_DEFAULT=n)

### Watchdog
- Main task watchdog enabled (15 second timeout)
- Reset with `esp_task_wdt_reset()` in main loop
- OCT PSRAM mode requires disabling watchdogs due to interrupt latency

### Power Optimization
- CPU frequency: 240MHz
- Compiler optimization: Size (-Os)
- Power management enabled for FreeRTOS idle
- Heap poisoning and tracing disabled in production

### Credentials (currently hardcoded)
- WiFi SSID: "Acres of Ice" (not actively used, SIM preferred)
- WiFi Password: "UkDfPNEj5@" (in main.c, should be moved to config)
- MQTT broker: mqtt://broker.hivemq.com:1883

### Known Issues
- WiFi code present but disabled in favor of SIM connectivity
- Some commented-out RPC functions (state.get, state.set)
- Device ID is hardcoded, not auto-generated
